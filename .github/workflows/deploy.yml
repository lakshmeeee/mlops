name: CI/CD to GKE with CML

on:
  push:
    branches: [ "main" ]

env:
  PROJECT_ID: sheetgpt-385916
  REGION: us-central1-a
  CLUSTER_NAME: mlops-assignment-cluster
  REPO_NAME: iris-api-repo
  IMAGE_NAME: iris-api
  GCS_DATA_PATH: gs://mlops-week1/v1/data/data.csv
  MODEL_PATH: gs://mlops-week1/week6/model.joblib
  DEPLOYMENT_DIR: k8s  # directory containing your YAML files

jobs:
  build-test-deploy:
    runs-on: ubuntu-latest

    steps:
    # -------------------------------
    # 1️⃣ Checkout code
    # -------------------------------
    - name: Checkout code
      uses: actions/checkout@v4

    # -------------------------------
    # 2️⃣ Authenticate to Google Cloud
    # -------------------------------
    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SERVICE_KEY }}

    - name: Setup gcloud CLI
      uses: google-github-actions/setup-gcloud@v2
      with:
        project_id: ${{ env.PROJECT_ID }}
        install_components: gke-gcloud-auth-plugin
        
    # Set up CML (for model metrics reporting)
    - name: Set up CML
      uses: iterative/setup-cml@v2

    # -------------------------------
    # 3️⃣ Setup Python + dependencies
    # -------------------------------
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        pip install -r requirements.txt

    # -------------------------------
    # 4️⃣ Download model and data
    # -------------------------------
    - name: Fetch data and model
      run: |
        mkdir -p data
        gsutil cp $GCS_DATA_PATH data/data.csv
        gsutil cp $MODEL_PATH model.joblib

    # -------------------------------
    # 5️⃣ Run tests
    # -------------------------------
    - name: Run tests
      run: |
        PYTHONPATH=. pytest -v --disable-warnings

    # -------------------------------
    # 6️⃣ Build and push Docker image
    # -------------------------------
    - name: Configure Docker for Artifact Registry
      run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev --quiet

    - name: Build Docker image
      run: |
        docker build -t ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/${{ env.IMAGE_NAME }}:latest .

    - name: Push Docker image
      run: |
        docker push us-central1-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/${{ env.IMAGE_NAME }}:latest

    # -------------------------------
    # 7️⃣ Deploy to GKE
    # -------------------------------
    - name: Configure kubectl and connect to cluster
      run: |
        gcloud container clusters get-credentials ${{ env.CLUSTER_NAME }} --region=${{ env.REGION }} --project=${{ env.PROJECT_ID }}

    - name: Deploy updated manifests
      run: |
        export USE_GKE_GCLOUD_AUTH_PLUGIN=True
        kubectl apply -f ${{ env.DEPLOYMENT_DIR }}/deployment.yaml
        kubectl apply -f ${{ env.DEPLOYMENT_DIR }}/service.yaml
        kubectl apply -f ${{ env.DEPLOYMENT_DIR }}/hpa.yaml

    # -------------------------------
    # 8️⃣ Validate Deployment
    # -------------------------------
    - name: Verify rollout
      run: |
        kubectl rollout status deployment/mlops-assignment-service --timeout=120s
        kubectl get pods -o wide
        kubectl get hpa

    # -------------------------------
    # 9️⃣ Post CML Report to PR / Commit
    # -------------------------------
    - name: Post CML Report
      env:
        REPO_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "## ✅ CI/CD Pipeline Report" > report.md
        echo "**Project:** ${{ env.PROJECT_ID}}" >> report.md
        echo "**Cluster:** ${{ env.CLUSTER_NAME}}" >> report.md
        echo "**Image:** ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/${{ env.IMAGE_NAME }}:latest" >> report.md
        echo "**Deployment:** mlops-assignment-service" >> report.md
        echo "**Tests:** Passed ✅" >> report.md
        echo "**Auto Scaling:** Applied (minPods=1, maxPods=3)" >> report.md
        echo "**Deployment URL:** Check LoadBalancer IP from GKE Service" >> report.md

        # Post CML comment to PR or commit
        cml comment create report.md

